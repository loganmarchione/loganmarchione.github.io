<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Deploying Hugo with CloudFront and S3 (for real this time) | Logan Marchione</title>
<meta name="keywords" content="">
<meta name="description" content="Hey! Listen! This post is part of a series on deploying Hugo. Check them all out!
Date URL Part 2023-11-08 Deploying Hugo with CloudFront and S3 (for real this time) Deploying Hugo with CloudFront and S3 (for real this time) 2022-02-08 Deploying Hugo with Netlify Deploying on Netlify 2021-10-13 Deploying Hugo with CloudFront and S3 Deploying on CloudFront and S3 2021-09-21 Deploying Hugo with AWS Amplify Deploying on Amplify TL;DR Good news everyone!">
<meta name="author" content="Logan Marchione">
<link rel="canonical" href="https://loganmarchione.github.io/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4117d964c20f142572c34772d5a912b3681e6e9317e9f2de59739813b764caeb.css" integrity="sha256-QRfZZMIPFCVyw0dy1akSs2gebpMX6fLeWXOYE7dkyus=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://loganmarchione.github.io/assets/favicon/favicon_loganmarchione_logo.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://loganmarchione.github.io/assets/favicon/favicon_loganmarchione_logo.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://loganmarchione.github.io/assets/favicon/favicon_loganmarchione_logo.svg">
<link rel="apple-touch-icon" href="https://loganmarchione.github.io/assets/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://loganmarchione.github.io/assets/favicon/favicon_loganmarchione_logo.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script async defer data-domain="loganmarchione.com" src="https://plausible.io/js/plausible.js"></script><meta property="og:title" content="Deploying Hugo with CloudFront and S3 (for real this time)" />
<meta property="og:description" content="Hey! Listen! This post is part of a series on deploying Hugo. Check them all out!
Date URL Part 2023-11-08 Deploying Hugo with CloudFront and S3 (for real this time) Deploying Hugo with CloudFront and S3 (for real this time) 2022-02-08 Deploying Hugo with Netlify Deploying on Netlify 2021-10-13 Deploying Hugo with CloudFront and S3 Deploying on CloudFront and S3 2021-09-21 Deploying Hugo with AWS Amplify Deploying on Amplify TL;DR Good news everyone!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://loganmarchione.github.io/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/" />
<meta property="og:image" content="https://loganmarchione.github.io/assets/featured/featured_aws_cloudfront_s3.svg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-11-08T00:00:00+00:00" /><meta property="og:site_name" content="Logan Marchione" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://loganmarchione.github.io/assets/featured/featured_aws_cloudfront_s3.svg" />
<meta name="twitter:title" content="Deploying Hugo with CloudFront and S3 (for real this time)"/>
<meta name="twitter:description" content="Hey! Listen! This post is part of a series on deploying Hugo. Check them all out!
Date URL Part 2023-11-08 Deploying Hugo with CloudFront and S3 (for real this time) Deploying Hugo with CloudFront and S3 (for real this time) 2022-02-08 Deploying Hugo with Netlify Deploying on Netlify 2021-10-13 Deploying Hugo with CloudFront and S3 Deploying on CloudFront and S3 2021-09-21 Deploying Hugo with AWS Amplify Deploying on Amplify TL;DR Good news everyone!"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://loganmarchione.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Deploying Hugo with CloudFront and S3 (for real this time)",
      "item": "https://loganmarchione.github.io/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Deploying Hugo with CloudFront and S3 (for real this time)",
  "name": "Deploying Hugo with CloudFront and S3 (for real this time)",
  "description": "Hey! Listen! This post is part of a series on deploying Hugo. Check them all out!\nDate URL Part 2023-11-08 Deploying Hugo with CloudFront and S3 (for real this time) Deploying Hugo with CloudFront and S3 (for real this time) 2022-02-08 Deploying Hugo with Netlify Deploying on Netlify 2021-10-13 Deploying Hugo with CloudFront and S3 Deploying on CloudFront and S3 2021-09-21 Deploying Hugo with AWS Amplify Deploying on Amplify TL;DR Good news everyone!",
  "keywords": [
    
  ],
  "articleBody": "Hey! Listen! This post is part of a series on deploying Hugo. Check them all out!\nDate URL Part 2023-11-08 Deploying Hugo with CloudFront and S3 (for real this time) Deploying Hugo with CloudFront and S3 (for real this time) 2022-02-08 Deploying Hugo with Netlify Deploying on Netlify 2021-10-13 Deploying Hugo with CloudFront and S3 Deploying on CloudFront and S3 2021-09-21 Deploying Hugo with AWS Amplify Deploying on Amplify TL;DR Good news everyone! If you’re reading this (in late 2023), you’re reading it via CloudFront instead of a VPS!\nIntroduction Two years ago, I wrote about deploying this site to CloudFront and S3. I had a test version of the site running, but there were too many moving pieces, and to be honest, I wasn’t that well-versed in Terraform or AWS.\nIn those two years, I tried a half-dozen times to move to a static-friendly host, but none of them had all of the features I wanted (below). AWS Amplify came close, but didn’t have IPv6 support.\nEase of setup Git-aware by default Separate dev/prod sites IPv6 (using your own DNS) Custom HTTP headers HTTP redirects SSL/TLS In that last post, I said:\nIf I’m going to switch, it needs to be easier than Nginx.\nNow, I’m eating those words. I’ve stepped up my game and decided to try again with hosting this site on CloudFront and S3.\nDesign decisions Terraform code Not going to lie, this took me a solid week to come up with. I have multiple static sites and I wanted them to all have the same setup (without duplicating Terraform code), so I wrote a Terraform module, which I published to GitHub. You can read the details and code on GitHub, but this module creates the S3 buckets, ACM certificate, Route53 entries, CloudFront distribution, and more.\n################################################################################ ### Module for static site ################################################################################ module \"static_site_domain_com\" { source = \"github.com/loganmarchione/terraform-aws-static-site?ref=0.1.6\" providers = { aws.us-east-1 = aws.us-east-1 } # The domain name of the site (**MUST** match the Route53 hosted zone name (e.g., `domain.com`) domain_name = \"domain.com\" # Since this is a static site, we probably don't need versioning, since our source files are stored in git bucket_versioning_logs = false bucket_versioning_site = false # CloudFront settings cloudfront_compress = true cloudfront_default_root_object = \"index.html\" cloudfront_enabled = true cloudfront_function_create = false cloudfront_function_filename = \"function.js\" cloudfront_function_name = \"ReWrites\" cloudfront_http_version = \"http2and3\" cloudfront_ipv6 = true cloudfront_price_class = \"PriceClass_100\" cloudfront_ssl_minimum_protocol_version = \"TLSv1.2_2021\" cloudfront_ttl_min = 3600 cloudfront_ttl_default = 86400 cloudfront_ttl_max = 2592000 cloudfront_viewer_protocol_policy = \"redirect-to-https\" # IAM iam_policy_site_updating = false # Upload default files upload_index = false upload_robots = false upload_404 = false } Yes, there were existing modules that created static sites (one, two, three), but none of them did exactly what I wanted, so I wrote my own. Therefore, it’s pretty opinionated and you may not like some of the decisions I’ve made (but there are plenty of options to change).\nCloudFront The main thing that kept me from moving away from my VPS was Nginx. I’ve been using it for years, it’s easy to configure, it’s a single server, it’s simple, and it has so many options.\nCloudFront, however, is a content delivery network (CDN), not a webserver. Because of that, it doesn’t do all of the webserver-type things that I was used to with Nginx.\nFunctions CloudFront Function are written in Javascript and do lightweight tasks like change headers, rewrite URLs, etc… To get some of my Nginx-like functionality into CloudFront, I had to use CloudFront Functions.\nFirst, CloudFront has a concept of default root objects. If you don’t set a default root object, visiting https://example.com returns an error. However, you can manually type https://example.com/index.html to view the page (this is ugly). To fix this, set index.html as the default root object and visit https://example.com, it works!\nBut, if you visit any sub-page like https://example.com/foo, you get an error. Again, you can manually type https://example.com/foo/index.html to view the page (this is ugly). As you can see, default root objects don’t work for sub-pages (because CloudFront isn’t a webserver).\nSecond, I wanted to do URL rewrites/redirects (e.g., redirect /feed to /index.xml) like I did in Nginx (below).\nlocation /feed { rewrite ^/feed$ /index.xml; } To fix both of these issues, I created a CloudFront Function that is optionally applied via my Terraform module.\nfunction handler(event) { var request = event.request; var uri = request.uri; // Responses var response_feed = { statusCode: 301, statusDescription: \"Moved Permanently\", headers: { \"location\": { \"value\": \"/index.xml\" } } } // Returns if (uri === \"/feed\" || uri === \"/feed/\") { return response_feed; } // https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/example-function-add-index.html // Check whether the URI is missing a file name. if (uri.endsWith('/')) { request.uri += 'index.html'; } // Check whether the URI is missing a file extension. else if (!uri.includes('.')) { request.uri += '/index.html'; } // If none of the above conditions are met, return the original request return request; } Caching Caching was (and still is) harder than I thought it would be. There are two kinds of caching:\nbrowser caching (this is done by the user’s browser and is hard for me to control) CDN caching (this is done by CloudFront and is controlled by me) When someone visits a website and their browser tries to download https://example.com/foo.jpg, it first checks its local cache. If the file is there, it doesn’t need to download it again, which makes the rest of the site load faster.\nWith Nginx, I was able to request that the user’s browser cache files for a set number of days, based on filetype.\nlocation / { try_files $uri $uri/ =404; #Cache these filetypes in the user's browser for a set number of days location ~* \\.(atom|bmp|css|doc|gif|ico|jpeg|jpg|js|pdf|png|ppt|rss|svg|tiff|ttf|woff|woff2|xls|zip)$ { expires 10d; add_header 'Cache-Control' 'private, must-revalidate'; } } However, what if I pushed an update to my site and wanted the user to download an asset again? I couldn’t control that (because it was set to expire after 10 days) and now the user is viewing a version of my site with a mix of old and new assets. Obviously, I could have (and probably should have) set the number of days lower than 10, but setting it too low defeats the purpose of a cache in the first place.\nThe same problem applies to CloudFront, except now there is a second cache in the mix. When I push updates to S3, how can I tell CloudFront to update its copy of my static assets? Below is a recreation of Josh Barratt’s diagram that I think does a really good job of visualizing this.\nTo solve these issues, I did a couple things.\nFor browser cache, you can’t actually set this in CloudFront (again, CloudFront is not a webserver). Instead, I set the Cache-Control header on specific files in my Hugo config.yaml file, which is read during the hugo deploy command (more on that later). This actually sets the metadata on the files in S3, then CloudFront just forwards that metadata to the user. Also, notice how I turned the expiration time down to 86400 (one day) instead of 10 days, and that html, json, and xml files are only cached for 3600 (one hour).\ndeployment: targets: ... ... ... matchers: # cached with gzip compression enabled - pattern: \"^.+\\\\.(js|css|md|otf|svg|ttf|txt)$\" cacheControl: \"max-age=604800, no-transform, public\" gzip: true # cached with gzip compression disabled - pattern: \"^.+\\\\.(bmp|gif|ico|jpeg|jpg|mp3|mp4|pdf|png|rss|tiff|woff|woff2)$\" cacheControl: \"max-age=604800, no-transform, public\" gzip: false # sitemap gets a special content-type header - pattern: \"^sitemap\\\\.xml$\" contentType: \"application/xml\" cacheControl: \"max-age=3600, no-transform, public\" gzip: true # cached with gzip compression enabled - pattern: \"^.+\\\\.(html|json|xml)$\" cacheControl: \"max-age=3600, no-transform, public\" gzip: true For CloudFront cache, I’ve setup multiple time-to-live (TTL) values that control how long the files stay in CloudFront’s cache. It’s important to try to strike a balance between how long the files live in CloudFront, and how often they come from S3.\nminimum TTL = 3600 (one hour) default TTL = 86400 (one day) maximum TTL = 2592000 (30 days) To force CloudFront to refresh all files in its cache when I do a deploy, I’ve setup my deployment script to force invalidation (more on that below).\nGitHub Actions With my VPS, I was using GitHub Actions to build my site, then using rsync to move the files from the GitHub Actions runner to my VPS.\n... ... ... - name: Build run: hugo --gc --baseURL=\"https://${{ env.URL_PRD }}\" - name: SSH setup run: | mkdir -p ~/.ssh echo \"${{ secrets.DEPLOY_KEY }}\" \u003e ~/.ssh/deploy_key ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} ${{ env.URL_PRD }} \u003e ~/.ssh/known_hosts chmod -R 700 ~/.ssh chmod 600 ~/.ssh/deploy_key - name: Rsync run: | rsync -rltvz --delete --omit-dir-times \\ -e \"ssh -i ~/.ssh/deploy_key -p ${{ secrets.DEPLOY_PORT }}\" public/ \\ ${{ secrets.DEPLOY_USER }}@${{ env.URL_PRD }}:/var/www/${{ env.URL_PRD }} For the switchover, I would need some way to push the files to S3. Luckily, Hugo has a built-in deploy command, which can upload files to S3 and invalidate CloudFront cache automatically.\nHowever, then comes the problem of authentication. I was initially going to create a long-lived AWS access key to use in my GitHub Actions, but kept reading about how great OpenID Connect (OIDC) is. It’s still black magic to me, but basically, it allows GitHub Actions to send files to AWS S3 with no passwords or keys involved! 🤯\nUsing some open source modules (one, two), I was able to setup GitHub as an OIDC provider in my AWS account, and create a role that GitHub Actions was able to assume.\n################################################################################ ### Module for OIDC provider ################################################################################ module \"oidc_provider\" { source = \"github.com/terraform-aws-modules/terraform-aws-iam?ref=v5.30.0//modules/iam-github-oidc-provider\" } ################################################################################ ### Module for GitHub OIDC role ################################################################################ module \"iam_github_oidc_role_loganmarchione_com\" { source = \"github.com/terraform-aws-modules/terraform-aws-iam?ref=v5.30.0//modules/iam-github-oidc-role\" name = \"GitHubActionsOIDC-loganmarchione-com\" policies = { SiteUpdating-loganmarchione-com = module.static_site_loganmarchione_com.site_updating_iam_policy_arn } subjects = [\"loganmarchione/loganmarchione.com:*\"] } My module has the option to create the IAM policy (called SiteUpdating-loganmarchione-com) needed to allow the GitHub OIDC role to update the files in S3 and create the cache invalidation.\n{ \"Version\" : \"2012-10-17\", \"Id\" : \"SiteUpdating\", \"Statement\" : [ { \"Sid\" : \"S3\", \"Effect\" : \"Allow\", \"Action\" : [ \"s3:GetBucketPolicy\", \"s3:PutBucketPolicy\", \"s3:ListBucket\", \"s3:PutObject\", \"s3:GetObject\", \"s3:DeleteObject\", ], \"Resource\" : [ aws_s3_bucket.site.arn, \"${aws_s3_bucket.site.arn}/*\" ] }, { \"Sid\" : \"CloudFront\", \"Effect\" : \"Allow\", \"Action\" : [ \"cloudfront:CreateInvalidation\", \"cloudfront:GetInvalidation\", \"cloudfront:ListInvalidations\" ], \"Resource\" : aws_cloudfront_distribution.site.arn } ] } Then, I was able to use these GitHub Actions to get everything working. Magically, the files are uploaded to S3 without a password!\n... ... ... permissions: id-token: write contents: read ... ... ... steps: ... ... ... - name: Configure AWS credentials uses: aws-actions/configure-aws-credentials@v4 with: role-to-assume: ${{ secrets.ROLE_TO_ASSUME_ARN_PRD }} role-duration-seconds: 900 aws-region: us-east-2 - name: Build run: hugo --gc -DEF --baseURL=\"https://${{ env.URL }}\" env: URL: loganmarchione.com - name: Deploy to S3 run: hugo deploy --maxDeletes -1 --invalidateCDN --target loganmarchione-com --logLevel info Credit to these two blogs (one, two) for working examples. The docs for AWS and GitHub are also linked here and here, respectively.\nArchitecture In the end, this is what I ended up with.\nThings gained/lost What did I gain and lose by switching from a VPS to CloudFront and S3?\nGained First is speed. Hosting on a single VPS with a local disk is fast (if you happen to be physically close to the VPS), but CloudFront puts me on every continent (if I want to pay for it).\nSecond is capacity. Not that my site is popular, but CloudFront has almost infinite capacity for traffic. Once CloudFront caches an object from S3 and distributes the object across its network, it’s almost immune to any sort of traffic spike or DDoS.\nThird is complexity (this is a negative). My site infrastructure is infinitely more complicated, and as AWS roles out new features, I’ll have to update my Terraform to take advantage of them. I do this for a living, but I’ll have to see what the maintenance overhead is over time.\nLost First is simplicity. This was not easy to setup and took me weeks between writing the module, debugging the module, writing IAM policies, testing, etc…\nSecond is freedom. This basically locks me into AWS. Not saying that I can’t go back to a VPS (because my static site is just a bunch of HTML/CSS/JavaScript), but I’m now dependent on AWS (which never goes down 🤪).\nThird is maintenance (this is actually a positive). I no longer have to install/patch/maintain/backup a VPS, which is nice.\nTraffic and cost My site isn’t super busy, so it’s very efficient to run via a CDN instead of a dedicated VPS. I cut over from my VPS to CloudFront on 2023-09-24, so the stats below are from 2023-10-01 to 2023-10-31.\nI use Plausible for analytics. Below you can see my traffic patterns for October 2023 (the first month on the VPS).\nBelow is data from the CloudFront dashboard. Here you can see the total HTTP requests (average is ~8500/day) and cache hit rate (~81%).\nThe next two graphs show the data transfer to viewers (~8GB for October 2023) and the HTTP status codes (~95% 2xx and 3xx).\nThis graph shows data transfer by destination.\nI was using a $6/month Digital Ocean droplet as my VPS. I already had my DNS in Route53, which was costing me $0.50/month for the hosted zone.\nItem Cost Route53 $0.50 DigitalOcean $6 Using the AWS Pricing Calculator, I guessed that the site would end up costing me around $2/month (including the $0.50 I was already paying for Route53). In reality, it ended up costing less than $1/month (note that I’m no longer in the 12-month AWS Free Tier).\nItem Cost Route53 $0.50 S3 (less than 300MB) $0.10 ACM $0 (free for public SSL/TLS certs) CloudFront $0 (I’m under the Always Free Tier) As a safeguard, I always recommend creating an AWS Budget in Terraform. This budget below will alert me if my forcasted spend per month is over $10.\nresource \"aws_budgets_budget\" \"monthly_cost_forecast\" { name = \"total-budget-monthly\" budget_type = \"COST\" limit_amount = \"10\" limit_unit = \"USD\" time_unit = \"MONTHLY\" time_period_start = formatdate(\"YYYY-MM-DD_hh:mm\", timestamp()) notification { comparison_operator = \"GREATER_THAN\" threshold = 100 threshold_type = \"PERCENTAGE\" notification_type = \"FORECASTED\" subscriber_email_addresses = [var.email_logan] } lifecycle { ignore_changes = [ # Let's ignore `time_period_start` changes because we use `timestamp()` to populate # this attribute. We only want `time_period_start` to be set upon initial provisioning. time_period_start, ] } } Conclusion It’s been over a month now and I have no complaints! AWS hasn’t gone down yet (knock on wood), and I’m happy to retire another server and save some money while doing it!\n-Logan\n",
  "wordCount" : "2394",
  "inLanguage": "en",
  "image":"https://loganmarchione.github.io/assets/featured/featured_aws_cloudfront_s3.svg","datePublished": "2023-11-08T00:00:00Z",
  "dateModified": "2023-11-08T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Logan Marchione"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://loganmarchione.github.io/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Logan Marchione",
    "logo": {
      "@type": "ImageObject",
      "url": "https://loganmarchione.github.io/assets/favicon/favicon_loganmarchione_logo.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://loganmarchione.github.io" accesskey="h" title="Logan Marchione (Alt + H)">
                <img src="https://loganmarchione.github.io/assets/favicon/favicon_loganmarchione_logo.svg" alt="" aria-label="logo"
                    height="35">Logan Marchione</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://loganmarchione.github.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://loganmarchione.github.io/privacy" title="Privacy">
                    <span>Privacy</span>
                </a>
            </li>
            <li>
                <a href="https://loganmarchione.github.io/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://loganmarchione.github.io/index.xml" title="RSS">
                    <span>RSS</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Deploying Hugo with CloudFront and S3 (for real this time)
    </h1>
    <div class="post-meta"><span title='2023-11-08 00:00:00 +0000 UTC'>2023-11-08</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2394 words&nbsp;·&nbsp;Logan Marchione

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://loganmarchione.github.io/assets/featured/featured_aws_cloudfront_s3.svg" alt="featured image">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#tldr" aria-label="TL;DR">TL;DR</a></li>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#design-decisions" aria-label="Design decisions">Design decisions</a><ul>
                        
                <li>
                    <a href="#terraform-code" aria-label="Terraform code">Terraform code</a></li>
                <li>
                    <a href="#cloudfront" aria-label="CloudFront">CloudFront</a><ul>
                        
                <li>
                    <a href="#functions" aria-label="Functions">Functions</a></li>
                <li>
                    <a href="#caching" aria-label="Caching">Caching</a></li></ul>
                </li>
                <li>
                    <a href="#github-actions" aria-label="GitHub Actions">GitHub Actions</a></li>
                <li>
                    <a href="#architecture" aria-label="Architecture">Architecture</a></li></ul>
                </li>
                <li>
                    <a href="#things-gainedlost" aria-label="Things gained/lost">Things gained/lost</a><ul>
                        
                <li>
                    <a href="#gained" aria-label="Gained">Gained</a></li>
                <li>
                    <a href="#lost" aria-label="Lost">Lost</a></li></ul>
                </li>
                <li>
                    <a href="#traffic-and-cost" aria-label="Traffic and cost">Traffic and cost</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Hey! Listen! This post is part of a series on deploying Hugo. Check them all out!</p>
<table>
<thead>
<tr>
<th>Date</th>
<th>URL</th>
<th>Part</th>
</tr>
</thead>
<tbody>
<tr>
<td>2023-11-08</td>
<td><a href="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/">Deploying Hugo with CloudFront and S3 (for real this time)</a></td>
<td>Deploying Hugo with CloudFront and S3 (for real this time)</td>
</tr>
<tr>
<td>2022-02-08</td>
<td><a href="/2022/02/deploying-hugo-with-netlify/">Deploying Hugo with Netlify</a></td>
<td>Deploying on Netlify</td>
</tr>
<tr>
<td>2021-10-13</td>
<td><a href="/2021/10/deploying-hugo-with-cloudfront-and-s3/">Deploying Hugo with CloudFront and S3</a></td>
<td>Deploying on CloudFront and S3</td>
</tr>
<tr>
<td>2021-09-21</td>
<td><a href="/2021/09/deploying-hugo-with-aws-amplify/">Deploying Hugo with AWS Amplify </a></td>
<td>Deploying on Amplify</td>
</tr>
</tbody>
</table>
<h1 id="tldr">TL;DR<a hidden class="anchor" aria-hidden="true" href="#tldr">#</a></h1>
<p>Good news everyone! If you&rsquo;re reading this (in late 2023), you&rsquo;re reading it via CloudFront instead of a VPS!</p>
<p><img loading="lazy" src="/assets/memes/good_news_everyone.jpg" alt="meme"  />
</p>
<h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>Two years ago, I <a href="/2021/10/deploying-hugo-with-cloudfront-and-s3/">wrote</a> about deploying this site to CloudFront and S3. I had a test version of the site running, but there were too many moving pieces, and to be honest, I wasn&rsquo;t that well-versed in Terraform or AWS.</p>
<p>In those two years, I tried a half-dozen times to move to a static-friendly host, but none of them had <em>all</em> of the features I wanted (below). AWS Amplify came close, but didn&rsquo;t have IPv6 support.</p>
<ul>
<li>Ease of setup</li>
<li>Git-aware by default</li>
<li>Separate dev/prod sites</li>
<li>IPv6 (using your own DNS)</li>
<li>Custom HTTP headers</li>
<li>HTTP redirects</li>
<li>SSL/TLS</li>
</ul>
<p>In that last post, I said:</p>
<blockquote>
<p>If I’m going to switch, it needs to be easier than Nginx.</p>
</blockquote>
<p>Now, I&rsquo;m eating those words. I&rsquo;ve stepped up my game and decided to try again with hosting this site on CloudFront and S3.</p>
<h1 id="design-decisions">Design decisions<a hidden class="anchor" aria-hidden="true" href="#design-decisions">#</a></h1>
<h2 id="terraform-code">Terraform code<a hidden class="anchor" aria-hidden="true" href="#terraform-code">#</a></h2>
<p>Not going to lie, this took me a solid week to come up with. I have multiple static sites and I wanted them to all have the same setup (without duplicating Terraform code), so I wrote a Terraform module, which I <a href="https://github.com/loganmarchione/terraform-aws-static-site">published to GitHub</a>. You can read the details and code on GitHub, but this module creates the S3 buckets, ACM certificate, Route53 entries, CloudFront distribution, and more.</p>
<pre tabindex="0"><code>################################################################################
### Module for static site
################################################################################

module &#34;static_site_domain_com&#34; {
  source = &#34;github.com/loganmarchione/terraform-aws-static-site?ref=0.1.6&#34;

  providers = {
    aws.us-east-1 = aws.us-east-1
  }

  # The domain name of the site (**MUST** match the Route53 hosted zone name (e.g., `domain.com`)
  domain_name = &#34;domain.com&#34;

  # Since this is a static site, we probably don&#39;t need versioning, since our source files are stored in git
  bucket_versioning_logs = false
  bucket_versioning_site = false

  # CloudFront settings
  cloudfront_compress                     = true
  cloudfront_default_root_object          = &#34;index.html&#34;
  cloudfront_enabled                      = true
  cloudfront_function_create              = false
  cloudfront_function_filename            = &#34;function.js&#34;
  cloudfront_function_name                = &#34;ReWrites&#34;
  cloudfront_http_version                 = &#34;http2and3&#34;
  cloudfront_ipv6                         = true
  cloudfront_price_class                  = &#34;PriceClass_100&#34;
  cloudfront_ssl_minimum_protocol_version = &#34;TLSv1.2_2021&#34;
  cloudfront_ttl_min                      = 3600
  cloudfront_ttl_default                  = 86400
  cloudfront_ttl_max                      = 2592000
  cloudfront_viewer_protocol_policy       = &#34;redirect-to-https&#34;

  # IAM
  iam_policy_site_updating = false

  # Upload default files
  upload_index  = false
  upload_robots = false
  upload_404    = false
}
</code></pre><p>Yes, there were existing modules that created static sites (<a href="https://github.com/infrable-io/terraform-aws-static-website">one</a>, <a href="https://github.com/joshuamkite/terraform-aws-static-website-s3-cloudfront-acm">two</a>, <a href="https://github.com/terraform-aws-modules/terraform-aws-cloudfront">three</a>), but none of them did <em>exactly</em> what I wanted, so I wrote my own. Therefore, it&rsquo;s pretty opinionated and you may not like some of the decisions I&rsquo;ve made (but there are plenty of options to change).</p>
<h2 id="cloudfront">CloudFront<a hidden class="anchor" aria-hidden="true" href="#cloudfront">#</a></h2>
<p>The main thing that kept me from moving away from my VPS was <a href="https://nginx.org/">Nginx</a>. I&rsquo;ve been using it for years, it&rsquo;s easy to configure, it&rsquo;s a single server, it&rsquo;s simple, and it has <em>so many options</em>.</p>
<p>CloudFront, however, is a content delivery network (CDN), not a webserver. Because of that, it doesn&rsquo;t do all of the webserver-type things that I was used to with Nginx.</p>
<h3 id="functions">Functions<a hidden class="anchor" aria-hidden="true" href="#functions">#</a></h3>
<p><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cloudfront-functions.html">CloudFront Function</a> are written in Javascript and do lightweight tasks like change headers, rewrite URLs, etc&hellip; To get some of my Nginx-like functionality into CloudFront, I had to use CloudFront Functions.</p>
<p>First, CloudFront has a concept of <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DefaultRootObject.html#DefaultRootObjectHow">default root objects</a>. If you don&rsquo;t set a default root object, visiting <code>https://example.com</code> returns an error. However, you can manually type <code>https://example.com/index.html</code> to view the page (this is ugly). To fix this, set <code>index.html</code> as the default root object and visit <code>https://example.com</code>, it works!</p>
<p>But, if you visit any sub-page like <code>https://example.com/foo</code>, you get an error. Again, you can manually type <code>https://example.com/foo/index.html</code> to view the page (this is ugly). As you can see, default root objects don&rsquo;t work for sub-pages (because CloudFront isn&rsquo;t a webserver).</p>
<p>Second, I wanted to do URL rewrites/redirects (e.g., redirect <code>/feed</code> to <code>/index.xml</code>) like I did in Nginx (below).</p>
<pre tabindex="0"><code>  location /feed {
    rewrite ^/feed$ /index.xml;
  }
</code></pre><p>To fix both of these issues, I created a CloudFront Function that is optionally applied via my Terraform module.</p>
<pre tabindex="0"><code>function handler(event) {
    var request = event.request;
    var uri = request.uri;

    // Responses
    var response_feed = {
        statusCode: 301,
        statusDescription: &#34;Moved Permanently&#34;,
        headers: {
            &#34;location&#34;: { &#34;value&#34;: &#34;/index.xml&#34; }
        }
    }

    // Returns
    if (uri === &#34;/feed&#34; || uri === &#34;/feed/&#34;) {
        return response_feed;
    }

    // https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/example-function-add-index.html
    // Check whether the URI is missing a file name.
    if (uri.endsWith(&#39;/&#39;)) {
        request.uri += &#39;index.html&#39;;
    }
    // Check whether the URI is missing a file extension.
    else if (!uri.includes(&#39;.&#39;)) {
        request.uri += &#39;/index.html&#39;;
    }

    // If none of the above conditions are met, return the original request
    return request;
}
</code></pre><h3 id="caching">Caching<a hidden class="anchor" aria-hidden="true" href="#caching">#</a></h3>
<p>Caching was (and still is) harder than I thought it would be. There are two kinds of caching:</p>
<ul>
<li>browser caching (this is done by the user&rsquo;s browser and is hard for me to control)</li>
<li>CDN caching (this is done by CloudFront and is controlled by me)</li>
</ul>
<p>When someone visits a website and their browser tries to download <code>https://example.com/foo.jpg</code>, it first checks its local cache. If the file is there, it doesn&rsquo;t need to download it again, which makes the rest of the site load faster.</p>
<p>With Nginx, I was able to request that the user&rsquo;s browser cache files for a set number of days, based on filetype.</p>
<pre tabindex="0"><code>  location / {
    try_files $uri $uri/ =404;
    #Cache these filetypes in the user&#39;s browser for a set number of days
    location ~* \.(atom|bmp|css|doc|gif|ico|jpeg|jpg|js|pdf|png|ppt|rss|svg|tiff|ttf|woff|woff2|xls|zip)$ {
      expires 10d;
      add_header &#39;Cache-Control&#39; &#39;private, must-revalidate&#39;;
    }
  }
</code></pre><p>However, what if I pushed an update to my site and <em>wanted</em> the user to download an asset again? I couldn&rsquo;t control that (because it was set to expire after 10 days) and now the user is viewing a version of my site with a mix of old and new assets. Obviously, I could have (and probably should have) set the number of days lower than <code>10</code>, but setting it too low defeats the purpose of a cache in the first place.</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20230921_001p1_hu1369fdafbb16a360924c9bad02de6efc_32853_800x0_resize_catmullrom_3.png" loading="lazy" alt="nginx caching"></p>
<p>The same problem applies to CloudFront, except now there is a second cache in the mix. When I push updates to S3, how can I tell CloudFront to update its copy of my static assets? Below is a <a href="https://serialized.net/2017/06/maximizing-performance-with-cloudfront-s3-and-hugo/">recreation of Josh Barratt&rsquo;s diagram</a> that I think does a really good job of visualizing this.</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20230921_001p2_hua02f3cccf9e1fff92a865587a4921772_49060_800x0_resize_catmullrom_3.png" loading="lazy" alt="cloudfront caching"></p>
<p>To solve these issues, I did a couple things.</p>
<p>For browser cache, you can&rsquo;t actually set this in CloudFront (again, CloudFront is not a webserver). Instead, I set the <code>Cache-Control</code> header on specific files in my Hugo <code>config.yaml</code> file, which is read during the <code>hugo deploy</code> command (more on that later). This actually sets the <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingMetadata.html#SysMetadata">metadata</a> on the files in S3, then CloudFront just forwards that metadata to the user. Also, notice how I turned the expiration time down to <code>86400</code> (one day) instead of 10 days, and that <code>html</code>, <code>json</code>, and <code>xml</code> files are only cached for <code>3600</code> (one hour).</p>
<pre tabindex="0"><code>deployment:
  targets:
    ...
    ...
    ...
  matchers:
    # cached with gzip compression enabled
    - pattern: &#34;^.+\\.(js|css|md|otf|svg|ttf|txt)$&#34;
      cacheControl: &#34;max-age=604800, no-transform, public&#34;
      gzip: true
    # cached with gzip compression disabled
    - pattern: &#34;^.+\\.(bmp|gif|ico|jpeg|jpg|mp3|mp4|pdf|png|rss|tiff|woff|woff2)$&#34;
      cacheControl: &#34;max-age=604800, no-transform, public&#34;
      gzip: false
    # sitemap gets a special content-type header
    - pattern: &#34;^sitemap\\.xml$&#34;
      contentType: &#34;application/xml&#34;
      cacheControl: &#34;max-age=3600, no-transform, public&#34;
      gzip: true
    # cached with gzip compression enabled
    - pattern: &#34;^.+\\.(html|json|xml)$&#34;
      cacheControl: &#34;max-age=3600, no-transform, public&#34;
      gzip: true
</code></pre><p>For CloudFront cache, I&rsquo;ve setup multiple time-to-live (TTL) values that control how long the files stay in CloudFront&rsquo;s cache. It&rsquo;s important to try to strike a balance between how long the files live in CloudFront, and how often they come from S3.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesMinTTL">minimum TTL</a> = <code>3600</code> (one hour)</li>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesDefaultTTL">default TTL</a> = <code>86400</code> (one day)</li>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesMaxTTL">maximum TTL</a> = <code>2592000</code> (30 days)</li>
</ul>
<p>To force CloudFront to refresh all files in its cache when I do a deploy, I&rsquo;ve setup my deployment script to force invalidation (more on that below).</p>
<h2 id="github-actions">GitHub Actions<a hidden class="anchor" aria-hidden="true" href="#github-actions">#</a></h2>
<p>With my VPS, I was using GitHub Actions to build my site, then using rsync to move the files from the GitHub Actions runner to my VPS.</p>
<pre tabindex="0"><code>    ...
    ...
    ...
    - name: Build
      run: hugo --gc --baseURL=&#34;https://${{ env.URL_PRD }}&#34;

    - name: SSH setup
      run: |
        mkdir -p ~/.ssh
        echo &#34;${{ secrets.DEPLOY_KEY }}&#34; &gt; ~/.ssh/deploy_key
        ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} ${{ env.URL_PRD }} &gt; ~/.ssh/known_hosts
        chmod -R 700 ~/.ssh
        chmod 600 ~/.ssh/deploy_key

    - name: Rsync
      run: |
        rsync -rltvz --delete --omit-dir-times \
          -e &#34;ssh -i ~/.ssh/deploy_key -p ${{ secrets.DEPLOY_PORT }}&#34; public/ \
          ${{ secrets.DEPLOY_USER }}@${{ env.URL_PRD }}:/var/www/${{ env.URL_PRD }}
</code></pre><p>For the switchover, I would need some way to push the files to S3. Luckily, Hugo has a built-in <a href="https://gohugo.io/hosting-and-deployment/hugo-deploy/">deploy command</a>, which can upload files to S3 and invalidate CloudFront cache automatically.</p>
<p>However, then comes the problem of authentication. I was initially going to create a long-lived AWS access key to use in my GitHub Actions, but kept reading about how great <a href="https://en.wikipedia.org/wiki/OpenID#OpenID_Connect_(OIDC)">OpenID Connect</a> (OIDC) is. It&rsquo;s still black magic to me, but basically, it allows GitHub Actions to send files to AWS S3 with no passwords or keys involved! &#x1f92f;</p>
<p>Using some open source modules (<a href="https://github.com/terraform-aws-modules/terraform-aws-iam/tree/master/modules/iam-github-oidc-provider">one</a>, <a href="https://github.com/terraform-aws-modules/terraform-aws-iam/tree/master/modules/iam-github-oidc-role">two</a>), I was able to setup GitHub as an OIDC provider in my AWS account, and create a role that GitHub Actions was able to assume.</p>
<pre tabindex="0"><code>################################################################################
### Module for OIDC provider
################################################################################

module &#34;oidc_provider&#34; {
  source = &#34;github.com/terraform-aws-modules/terraform-aws-iam?ref=v5.30.0//modules/iam-github-oidc-provider&#34;
}

################################################################################
### Module for GitHub OIDC role
################################################################################

module &#34;iam_github_oidc_role_loganmarchione_com&#34; {
  source = &#34;github.com/terraform-aws-modules/terraform-aws-iam?ref=v5.30.0//modules/iam-github-oidc-role&#34;

  name = &#34;GitHubActionsOIDC-loganmarchione-com&#34;
  policies = {
    SiteUpdating-loganmarchione-com = module.static_site_loganmarchione_com.site_updating_iam_policy_arn
  }
  subjects = [&#34;loganmarchione/loganmarchione.com:*&#34;]
}
</code></pre><p>My module has the option to create the IAM policy (called <code>SiteUpdating-loganmarchione-com</code>) needed to allow the GitHub OIDC role to update the files in S3 and create the cache invalidation.</p>
<pre tabindex="0"><code>{
  &#34;Version&#34; : &#34;2012-10-17&#34;,
  &#34;Id&#34; : &#34;SiteUpdating&#34;,
  &#34;Statement&#34; : [
    {
      &#34;Sid&#34; : &#34;S3&#34;,
      &#34;Effect&#34; : &#34;Allow&#34;,
      &#34;Action&#34; : [
        &#34;s3:GetBucketPolicy&#34;,
        &#34;s3:PutBucketPolicy&#34;,
        &#34;s3:ListBucket&#34;,
        &#34;s3:PutObject&#34;,
        &#34;s3:GetObject&#34;,
        &#34;s3:DeleteObject&#34;,
      ],
      &#34;Resource&#34; : [
        aws_s3_bucket.site.arn,
        &#34;${aws_s3_bucket.site.arn}/*&#34;
      ]
    },
    {
      &#34;Sid&#34; : &#34;CloudFront&#34;,
      &#34;Effect&#34; : &#34;Allow&#34;,
      &#34;Action&#34; : [
        &#34;cloudfront:CreateInvalidation&#34;,
        &#34;cloudfront:GetInvalidation&#34;,
        &#34;cloudfront:ListInvalidations&#34;
      ],
      &#34;Resource&#34; : aws_cloudfront_distribution.site.arn
    }
  ]
}
</code></pre><p>Then, I was able to use these GitHub Actions to get everything working. Magically, the files are uploaded to S3 without a password!</p>
<pre tabindex="0"><code>    ...
    ...
    ...
    permissions:
      id-token: write
      contents: read
    ...
    ...
    ...
    steps:
    ...
    ...
    ...
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.ROLE_TO_ASSUME_ARN_PRD }}
        role-duration-seconds: 900
        aws-region: us-east-2

    - name: Build
      run: hugo --gc -DEF --baseURL=&#34;https://${{ env.URL }}&#34;
      env:
        URL: loganmarchione.com

    - name: Deploy to S3
      run: hugo deploy --maxDeletes -1 --invalidateCDN --target loganmarchione-com --logLevel info
</code></pre><p>Credit to these two blogs (<a href="https://major.io/p/cloudfront-migration/">one</a>, <a href="https://robinvenables.com/posts/moving-away-from-aws-access-keys/">two</a>) for working examples. The docs for AWS and GitHub are also linked <a href="https://aws.amazon.com/blogs/security/use-iam-roles-to-connect-github-actions-to-actions-in-aws/">here</a> and <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services">here</a>, respectively.</p>
<h2 id="architecture">Architecture<a hidden class="anchor" aria-hidden="true" href="#architecture">#</a></h2>
<p>In the end, this is what I ended up with.</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20211012_001.png" loading="lazy" alt="architecture"></p>
<h1 id="things-gainedlost">Things gained/lost<a hidden class="anchor" aria-hidden="true" href="#things-gainedlost">#</a></h1>
<p>What did I gain and lose by switching from a VPS to CloudFront and S3?</p>
<h2 id="gained">Gained<a hidden class="anchor" aria-hidden="true" href="#gained">#</a></h2>
<p>First is speed. Hosting on a single VPS with a local disk is fast (if you happen to be physically close to the VPS), but CloudFront puts me on every continent (if I want to pay for it).</p>
<p>Second is capacity. Not that my site is popular, but CloudFront has almost infinite capacity for traffic. Once CloudFront caches an object from S3 and distributes the object across its network, it&rsquo;s almost immune to any sort of traffic spike or DDoS.</p>
<p>Third is complexity (this is a negative). My site infrastructure is infinitely more complicated, and as AWS roles out new features, I&rsquo;ll have to update my Terraform to take advantage of them. I do this for a living, but I&rsquo;ll have to see what the maintenance overhead is over time.</p>
<h2 id="lost">Lost<a hidden class="anchor" aria-hidden="true" href="#lost">#</a></h2>
<p>First is simplicity. This was not easy to setup and took me weeks between writing the module, debugging the module, writing IAM policies, testing, etc&hellip;</p>
<p>Second is freedom. This basically locks me into AWS. Not saying that I can&rsquo;t go back to a VPS (because my static site is just a bunch of HTML/CSS/JavaScript), but I&rsquo;m now dependent on AWS (which never goes down &#x1f92a;).</p>
<p>Third is maintenance (this is actually a positive). I no longer have to install/patch/maintain/backup a VPS, which is nice.</p>
<h1 id="traffic-and-cost">Traffic and cost<a hidden class="anchor" aria-hidden="true" href="#traffic-and-cost">#</a></h1>
<p>My site isn&rsquo;t super busy, so it&rsquo;s very efficient to run via a CDN instead of a dedicated VPS. I cut over from my VPS to CloudFront on 2023-09-24, so the stats below are from 2023-10-01 to 2023-10-31.</p>
<p>I use <a href="https://plausible.io/">Plausible</a> for analytics. Below you can see my traffic patterns for October 2023 (the first month on the VPS).</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20231108_001_hu68317caf0c6c2772d7b4212d1bdc708a_53497_800x0_resize_catmullrom_3.png" loading="lazy" alt="plausible"></p>
<p>Below is data from the CloudFront dashboard. Here you can see the total HTTP requests (average is ~8500/day) and cache hit rate (~81%).</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20231108_002.png" loading="lazy" alt="cloudfront stats"></p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20231108_003.png" loading="lazy" alt="cloudfront stats"></p>
<p>The next two graphs show the data transfer to viewers (~8GB for October 2023) and the HTTP status codes (~95% <code>2xx</code> and <code>3xx</code>).</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20231108_004.png" loading="lazy" alt="cloudfront stats"></p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20231108_005.png" loading="lazy" alt="cloudfront stats"></p>
<p>This graph shows data transfer by destination.</p>

<p><img src="/2023/11/deploying-hugo-with-cloudfront-and-s3-for-real-this-time/20231108_006.png" loading="lazy" alt="cloudfront stats"></p>
<p>I was using a $6/month Digital Ocean droplet as my VPS. I already had my DNS in Route53, which was costing me $0.50/month for the hosted zone.</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Route53</td>
<td>$0.50</td>
</tr>
<tr>
<td>DigitalOcean</td>
<td>$6</td>
</tr>
</tbody>
</table>
<p>Using the <a href="https://calculator.aws/">AWS Pricing Calculator</a>, I guessed that the site would end up costing me around $2/month (including the $0.50 I was already paying for Route53). In reality, it ended up costing less than $1/month (note that I&rsquo;m no longer in the <a href="https://aws.amazon.com/free/">12-month AWS Free Tier</a>).</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Route53</td>
<td>$0.50</td>
</tr>
<tr>
<td>S3 (less than 300MB)</td>
<td>$0.10</td>
</tr>
<tr>
<td>ACM</td>
<td>$0 (free for public SSL/TLS certs)</td>
</tr>
<tr>
<td>CloudFront</td>
<td>$0 (I&rsquo;m under the Always Free Tier)</td>
</tr>
</tbody>
</table>
<p>As a safeguard, I always recommend creating an <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/budgets_budget">AWS Budget in Terraform</a>. This budget below will alert me if my forcasted spend per month is over $10.</p>
<pre tabindex="0"><code>resource &#34;aws_budgets_budget&#34; &#34;monthly_cost_forecast&#34; {
  name              = &#34;total-budget-monthly&#34;
  budget_type       = &#34;COST&#34;
  limit_amount      = &#34;10&#34;
  limit_unit        = &#34;USD&#34;
  time_unit         = &#34;MONTHLY&#34;
  time_period_start = formatdate(&#34;YYYY-MM-DD_hh:mm&#34;, timestamp())

  notification {
    comparison_operator        = &#34;GREATER_THAN&#34;
    threshold                  = 100
    threshold_type             = &#34;PERCENTAGE&#34;
    notification_type          = &#34;FORECASTED&#34;
    subscriber_email_addresses = [var.email_logan]
  }

  lifecycle {
    ignore_changes = [
      # Let&#39;s ignore `time_period_start` changes because we use `timestamp()` to populate
      # this attribute. We only want `time_period_start` to be set upon initial provisioning.
      time_period_start,
    ]
  }
}
</code></pre><h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>It&rsquo;s been over a month now and I have no complaints! AWS hasn&rsquo;t gone down yet (knock on wood), and I&rsquo;m happy to retire another server and save some money while doing it!</p>
<p>-Logan</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on twitter"
        href="https://twitter.com/intent/tweet/?text=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29&amp;url=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f&amp;hashtags=">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f&amp;title=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29&amp;summary=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29&amp;source=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f&title=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on whatsapp"
        href="https://api.whatsapp.com/send?text=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29%20-%20https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on telegram"
        href="https://telegram.me/share/url?text=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29&amp;url=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Deploying Hugo with CloudFront and S3 (for real this time) on ycombinator"
        href="https://news.ycombinator.com/submitlink?t=Deploying%20Hugo%20with%20CloudFront%20and%20S3%20%28for%20real%20this%20time%29&u=https%3a%2f%2floganmarchione.github.io%2f2023%2f11%2fdeploying-hugo-with-cloudfront-and-s3-for-real-this-time%2f">
        <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
            <path
                d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://loganmarchione.github.io">Logan Marchione</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><div class="kb-club">
  <a target="_blank" href="https://512kb.club"><img src="/assets/assets/512kb-club-green-team.svg" alt="512kb club badge"></a>
</div>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
